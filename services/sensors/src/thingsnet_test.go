package main

import (
	"os"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestProcessWebhookSuccess(t *testing.T) {
	samples := map[string][]byte{
		"testdata/ttn1.json": {0x4a, 0x0, 0xc2, 0x31, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4b, 0x1, 0x14, 0x0, 0x0, 0x0, 0x0, 0x27, 0x84, 0x4c, 0x0, 0x0, 0x0, 0x0, 0x10, 0xde},
		"testdata/ttn2.json": {0x4a, 0x0, 0xc1, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4b, 0x1, 0x14, 0x0, 0x0, 0x0, 0x0, 0x27, 0x82, 0x4c, 0x0, 0x0, 0x0, 0x0, 0x10, 0xde},
		"testdata/ttn3.json": {0x4a, 0x0, 0xbc, 0x2d, 0x0, 0x0, 0x0, 0x40, 0x0, 0x0, 0x0, 0x4b, 0x1, 0x12, 0x0, 0x0, 0x0, 0x0, 0x27, 0x87, 0x4c, 0x0, 0x0, 0x0, 0x0, 0x10, 0xde},
	}
	for path, payload := range samples {
		file, err := os.Open(path)
		require.NoError(t, err)
		defer file.Close()
		resp, err := ProcessWebhook(file)
		require.NoError(t, err)
		assert.Equal(t, "winfred", resp.DeviceID)
		assert.Equal(t, payload, resp.Payload)
	}
}
